# Epic Online Services（EOS）による「友達とつなぐ」

**方針**: 自前サーバーの維持コストを避けるため、**まずは Epic Online Services（EOS）を採用**し、「友達とつなぐ」を実現する。

参照: [Epic Online Services - マルチプレイヤー](https://onlineservices.epicgames.com/ja/multiplayer)（ロイヤリティ・ホスティング料金なし）

---

## 1. 位置づけ

### 1.1 本ドキュメントと他ドキュメントの関係

| ドキュメント | 役割 |
|-------------|------|
| **本ドキュメント（EPIC_ONLINE_SERVICES.md）** | EOS 採用方針。友達・マッチング・ロビー・ボイスを EOS で賄う設計。プラグイン化の指針。 |
| [SERVER_DESIGN.md](./SERVER_DESIGN.md) | 自前 Phoenix サーバー設計。EOS を利用しない場合の代替、またはゲームルーム専用サーバーとして参照。 |
| [MULTIPLAYER_PHOENIX_CHANNELS.md](./MULTIPLAYER_PHOENIX_CHANNELS.md) | ゲームルーム（RoomChannel）・Engine 連携。EOS でマッチングした後の「ルーム参加」は、自前サーバーを立てる場合はここに従う。 |

### 1.2 採用理由

- **維持コスト**: 自前で認証・フレンド・プレゼンス・マッチング用サーバーを立てると、ホスティング・監視・スケールの負荷がかかる。EOS はロイヤリティ・ホスティング料金がかからず、マルチプレイ基盤を外注できる。
- **まずは友達とつなぐ**: フレンド・ロビー・セッション・ボイスチャットを EOS に任せ、ゲーム本編の「誰とどのルームでプレイするか」までを EOS で完結させることを第一目標とする。
- **将来の拡張**: ゲーム状態の同期は、EOS P2P を利用するか、必要に応じて自前 Phoenix サーバー（[SERVER_DESIGN.md](./SERVER_DESIGN.md)）を併用するかは、後段で選択する。

### 1.3 EOS と自前サーバーの切り替え

**方針**: EOS を使うか、自前サーバー（Phoenix）を使うかを **設定で切り替え可能** にする。

- **設定**（例: `config :game, :multiplayer_backend, :eos` または `:self_hosted`）で、起動時にどちらのバックエンドを使うか決定する。
- **ゲーム・UI 層**は「友達リスト取得」「ロビー作成・参加」「セッション参加」などの **共通インターフェース（Behaviour または Adapter）** にのみ依存し、その実装として EOS 用モジュールと自前サーバー用モジュールを差し替える。
- これにより、運用コストを抑えたいときは EOS、自前で制御したいときやオフライン検証時は自前サーバー、といった切り替えが可能になる。

---

## 2. EOS で賄う機能

[EOS マルチプレイヤー](https://onlineservices.epicgames.com/ja/multiplayer)で提供される機能のうち、本プロジェクトで利用する範囲を以下とする。

| EOS 機能 | 用途 | 本プロジェクトでの利用 |
|----------|------|------------------------|
| **ロビー（Lobby）** | グループの作成・参加・離脱・管理、フレンドとのつながり | 友達を集めて「ルーム」に相当するグループを形成。誰がオンラインか・誰が同じロビーにいるかを EOS で管理。 |
| **セッション（Sessions）** | マッチのホスト・検索・参加 | プレイしたいマッチの作成・検索・参加。ロビーからゲーム開始に進むときの単位として利用。 |
| **ピアツーピア（P2P）** | ファイアウォール・NAT を越えた接続 | 接続確立・NAT トラバーサルを EOS に任せ、自前で STUN/TURN を用意しない選択肢を可能にする。 |
| **ボイスチャット** | クロスプラットフォーム音声 | マッチ中・ロビー内の会話。オプションとして組み込む。 |

認証・識別は EOS のアカウント（Epic アカウントやその他 IdP）を利用する。自前の Phoenix 認証と併用するか、EOS のみに統一するかは実装時に決定する。

---

## 3. アーキテクチャ（EOS 採用時）

### 3.1 全体の流れ

1. **クライアント起動** — EOS SDK を初期化し、Epic アカウント（または対応 IdP）でログイン。
2. **友達・ロビー** — EOS のフレンド・ロビー API で「友達リスト」「オンライン状態」「ロビー作成・参加・招待」を行う。
3. **セッション** — プレイ開始時に EOS のセッションでマッチをホストまたは参加。
4. **ゲーム本編** — いずれかの方式でゲーム状態を同期する（下記）。

### 3.2 ゲーム状態同期の選択肢（EOS 採用後）

| 方式 | 説明 | このプロジェクトでの対応 |
|------|------|----------------------------|
| **EOS P2P で状態を送受信** | ゲームの入力やスナップショットを P2P で配信。権威はホストクライアントまたは全員で合意。 | Engine（GameEvents + GameWorld）をホスト側で動かし、入力や状態を EOS P2P で配信する実装が必要。 |
| **自前サーバーでゲームのみ** | マッチング・友達は EOS、ゲームルームだけ自前 Phoenix サーバー（RoomChannel + Engine）で動かす。 | [MULTIPLAYER_PHOENIX_CHANNELS.md](./MULTIPLAYER_PHOENIX_CHANNELS.md) のとおり。EOS で「ルーム ID」相当を決め、その ID で Phoenix の RoomChannel に join する運用を想定。 |

まずは「友達とつなぐ」を EOS で実現することを優先し、ゲーム状態同期は **EOS P2P** か **自前ゲームサーバー** のどちらかを後から選ぶ形とする。

---

## 4. プラグインとしての実装方針

EOS を「エンジン用プラグイン」として組み込む場合の指針。

### 4.1 Rust 側

- **EOS SDK**: C API が公式に提供されている。Rust からは FFI で呼ぶか、既存の Rust バインディング（例: コミュニティの `eos-sdk` 系クレート）を利用する。
- **責務**: EOS の初期化・ログイン・ロビー・セッション・P2P・ボイス等の API をラップし、NIF またはポートプロセス経由で Elixir から呼び出す。
- **配置**: 本編の `native/game_native` に直接含めるか、別クレート（例: `game_eos`）に分離し、オプションでリンクするかを検討する。プラグインとして切り出すなら別クレートが望ましい。

### 4.2 Elixir 側

- **モジュール**: EOS 用の Elixir モジュール（例: `Engine.EOS` または別アプリ `game_eos`）を用意し、NIF/ポート経由で「ロビー作成」「参加」「招待」「セッション作成」等を呼び出す。
- **設定**: 設定でマルチプレイバックエンドを **EOS / 自前サーバー（Phoenix）** で切り替え可能にし、無効時はオフライン単体プレイとする（[§1.3 EOS と自前サーバーの切り替え](#13-eos-と自前サーバーの切り替え)）。
- **既存 Engine との関係**: Engine.RoomSupervisor / RoomRegistry はそのまま利用する。EOS で「どのルーム（セッション）にいるか」が決まり、そのルーム ID を Engine の `start_room` に渡す、といった連携を想定する。

### 4.3 実装の優先順位（提案）

| 順序 | 項目 | 内容 |
|------|------|------|
| 1 | EOS SDK の Rust ラッパー | 初期化・ログイン・ロビー一覧・作成・参加・離脱を NIF またはポートで Elixir に公開 |
| 2 | フレンド・招待 | EOS のフレンド API で友達リスト・招待を実装し、クライアント UI と接続 |
| 3 | セッション | プレイ開始時のセッション作成・検索・参加。ここで「ルーム ID」を確定し、Engine または P2P に引き渡す |
| 4 | ボイスチャット | 必要に応じて EOS ボイスを有効化 |
| 5 | ゲーム状態同期 | EOS P2P で行うか、自前 Phoenix（RoomChannel）で行うかを決定し、実装 |

---

## 5. 関連ドキュメント

| ドキュメント | 用途 |
|-------------|------|
| [SERVER_DESIGN.md](./SERVER_DESIGN.md) | 自前 Phoenix サーバー設計。EOS を使わない場合、またはゲームルーム専用サーバーとして参照 |
| [MULTIPLAYER_PHOENIX_CHANNELS.md](./MULTIPLAYER_PHOENIX_CHANNELS.md) | ゲームルーム（RoomChannel）・Engine 連携 |
| [STEPS_EXTENSION.md § Step 44](../05_steps/01_engine/STEPS_EXTENSION.md#6-step-44-マルチプレイ) | Step 44 の目標・44a/44b の区別 |
| [Epic Online Services - マルチプレイヤー](https://onlineservices.epicgames.com/ja/multiplayer) | EOS の機能概要・ドキュメントへのリンク |
