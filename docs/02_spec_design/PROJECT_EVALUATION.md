# プロジェクト全体評価（忌憚なき所見）

**評価対象**: Elixir × Rust ゲームエンジン（ヴァンサバデモ含む）  
**評価日**: 2026-02-25  
**ロードマップ参照**: Step 1〜47 完了状況、Step 48〜61（3D・Slot/コンポーネント）は計画段階

> 良い点も悪い点も包み隠さず書いた。意思決定や今後の優先度の参考にしてください。

---

## 目次

1. [達成度サマリー](#1-達成度サマリー)
2. [強み](#2-強み)
3. [弱み・課題](#3-弱み課題)
4. [技術的評価](#4-技術的評価)
5. [プロジェクト運営面の評価](#5-プロジェクト運営面の評価)
6. [総合所見（忌憚なく）](#6-総合所見忌憚なく)
7. [将来の展望とリスク](#7-将来の展望とリスク)
8. [関連ドキュメント](#8-関連ドキュメント)

---

## 1. 達成度サマリー

### 1.1 Step 40〜47 の実際の状態

| Step | 内容 | 状態 | 備考 |
|------|------|------|------|
| 40 | 2つ目のゲーム（MiniShooter） | ✅ 完了 | 汎用化の検証として有効 |
| 41 | ゲームループの Rust 移行 | ✅ 完了 | 60Hz 固定、GameEvents でイベント駆動 |
| 42 | マップ・障害物システム | ✅ 完了 | MapLoader、obstacle_resolve、空間ハッシュ |
| 43 | セーブ・ロード | ✅ 完了 | SaveManager、ハイスコア永続化 |
| 44a | マルチプレイ基盤（複数 GameWorld） | ✅ 完了 | RoomSupervisor、headless ルーム |
| 44b | Phoenix Channels 連携 | 未着手 | 設計のみ。実装は将来 |
| 45 | デバッグ支援（NIF） | ✅ 実装済み | `init_panic_hook`（debug ビルド）、`debug_dump_world` あり。RUST_LOG と Elixir Logger の統合は未整備 |
| 46 | GameLoop → GameEvents リネーム | ✅ 完了 | モジュール名が役割と一致 |
| 47 | Skeleton / Ghost / Garlic / 壁すり抜け | 未完了 | ブランチ `feature/step47-*` あり。SPEC との整合はまだ |

**補足**: 過去の評価では「Step 45 は部分的」とされていたが、現コードでは panic_hook と debug_dump_world は実装済み（debug ビルド時）。リリースビルドでは debug_dump_world は `:debug_build_only` を返す設計で妥当。

### 1.2 SPEC.md との照合

| 仕様項目 | 状態 |
|----------|------|
| Slime, Bat, Golem | ✅ 実装済み |
| Skeleton, Ghost | ❌ 未実装（Step 47 対象） |
| Magic Wand, Axe, Lightning, Whip | ✅ 実装済み |
| Garlic | ❌ 未実装 |
| 障害物（木・岩） | ✅ 実装済み |
| Ghost 壁すり抜け | ⚠️ 基盤（kind でスキップ可能）はあるが、Ghost 未実装のため未検証 |
| マップ 4096×4096 | ✅ 実装済み |
| ボス（Slime King, Bat Lord, Stone Golem） | ✅ 実装済み |

---

## 2. 強み

### 2.1 アーキテクチャの一貫性

- **Elixir と Rust の役割分担が設計から実装まで貫かれている** — 「苦手なものは Rust に投げる」が ELIXIR_RUST_DIVISION とコードの両方に現れている。
- **Engine.Game behaviour** — ゲーム層が NifBridge を直接触らず Engine 経由で使うため、境界が明確で差し替えがしやすい。
- **複数ゲームの同居** — VampireSurvivor と MiniShooter が同じ土台で動いており、「汎用エンジン」としての証明になっている。

### 2.2 パフォーマンス

- **Rust 側の最適化がきちんと入っている** — SoA ECS、フリーリスト、空間ハッシュ、rayon/SIMD、RwLock。ゲームループも Rust 主導で 60Hz のジッターが抑えられている。
- **wgpu インスタンシング** — 1 draw call で大量描画。デモ用途として十分な水準。
- **NIF 呼び出しの集約** — get_frame_metadata で 1 回取得にまとめるなど、境界のオーバーヘッドを意識した設計。

### 2.3 信頼性・運用面

- **OTP Supervisor** — SceneManager、InputHandler、EventBus、GameEvents 等を監視し、障害時はプロセス単位で再起動できる。
- **RoomSupervisor / RoomRegistry** — 複数ルームの並列管理と、将来の Phoenix Channels 連携を見据えた構成。
- **EventBus + FrameCache（ETS）** — フレームイベントのノンブロッキング配信とプロセス間共有が整理されている。

### 2.4 ドキュメント

- **設計・仕様・ロードマップが揃っている** — SPEC、ENGINE_STRENGTHS_WEAKNESSES、ELIXIR_RUST_DIVISION、STEPS 系が一通りあり、なぜその形にしたかが追いやすい。
- **Step 番号付きのコメント** — コードとドキュメントの対応が取りやすく、変更時の影響範囲を把握しやすい。
- **技術選定の理由が残っている** — WHY_ELIXIR、WHY_RUST、WHY_RAYON など、「あとから見ても理由が分かる」状態になっている。

### 2.5 技術的独自性

- **ゲームエンジンとして OTP を前面に出している** — 本番サービス的な耐障害性・分散性をゲームに持ち込む試みとして、他にあまり例がない。
- **分散・マルチへの拡張経路が設計されている** — Elixir/OTP の性質上、マルチノードや Phoenix 連携を考えたときに筋が良い。

---

## 3. 弱み・課題

### 3.1 デバッグ・開発体験

- **NIF パニック時** — Rust の panic は BEAM VM ごと落ちる。panic_hook で stderr にバックトレースは出るが、Elixir のスタックトレースには乗らない。2 言語をまたぐバグの切り分けは依然として重い。
- **RUST_LOG と Elixir Logger の連携** — 未整備。ログを一箇所で見るには手作業の対応が必要。
- **リリースビルドでは debug_dump_world が使えない** — 意図的な設計だが、本番に近い環境でワールド状態を手軽に確認する手段は限られる。

### 3.2 ビルド・環境の複雑さ

- **Elixir + Rust のデュアルビルド** — mix compile と cargo の両方が必要で、初回やクリーンビルドは時間がかかる。CI や新規メンバーのオンボーディングコストは無視できない。
- **音声アセットの事前生成** — Python スクリプト実行が前提。手順が増え、環境差が出やすい。
- **2 言語の習得・保守** — 参入障壁が高く、少人数・個人開発でないと負荷が大きい。

### 3.3 仕様・コンテンツとの乖離

- **Skeleton, Ghost, Garlic が未実装** — SPEC に書かれているがコンテンツとしては未着手。Step 47 で対応予定だが、仕様書だけ読むと「ある」と誤解しうる。
- **Ghost の壁すり抜け** — 障害物の kind でスキップする設計はあるが、Ghost 自体がないため実機検証されていない。

### 3.4 コードベースの規模と集中

- **native/game_native/src/lib.rs が 2200 行超** — NIF とゲームロジックが一ファイルに集約しており、可読性・変更影響の局所化の面で負債になりつつある。将来の Step 48〜61（3D、Slot/コンポーネント）を同じファイルに載せるとさらに肥大化するリスクがある。

### 3.5 エコシステム・マルチプレイ

- **Elixir × Rust ゲームの事例が少ない** — 情報収集やベストプラクティスの参照先が限られる。
- **44a は「並列セッション」** — 同一ワールド内の複数プレイヤー衝突などは未対応。Phoenix Channels（44b）は設計のみで未実装。

---

## 4. 技術的評価

### 4.1 コード品質

| 観点 | 評価 | コメント |
|------|------|----------|
| モジュール分離 | ◎ | Engine / Game / 各システムの責務がはっきりしている |
| テスト | ○ | SpawnSystem, LevelSystem, BossSystem、Rust の util/weapon 等にユニットテストあり。E2E・結合テストは少ない |
| エラーハンドリング | ○ | NifResult、rescue、:no_save 等のパターンはある。NIF 境界のエラー表現の統一はまだ余地あり |
| ドキュメント（@moduledoc / @doc） | ◎ | 主要モジュールに doc が付いており、Step 番号と対応が取りやすい |

### 4.2 パフォーマンス

- フレーム予算（物理・描画で 16ms 以内）を意識した設計。StressMonitor で監視可能。
- 5000 体クラスを想定した最適化が入っている。それ以上を狙うなら SIMD 強化や GPU コンピュートの検討が必要。
- NIF 境界のコピーは残るが、get_frame_metadata の 1 回取得などで許容範囲に収まっている。

### 4.3 セキュリティ・保守性

- セーブは term_to_binary でローカル保存。改ざん検知はないが、ローカル用途なら許容できる水準。
- 入力・敵数・座標などは Rust 側で制約しており、不正データへの防御はおおむね妥当。

---

## 5. プロジェクト運営面の評価

### 5.1 ロードマップの実行力

- **Step 1〜47 の多くが完了** — 基礎〜汎用化〜拡張まで、計画がコードに反映されている。
- **優先度の文書化** — PRIORITY_STEPS、STEPS_GENERALIZATION で「何をいつやるか」が共有しやすい。
- **スコープの明示** — ELIXIR_RUST_DIVISION で「サポートしない」と決めた項目を書いてあり、スコープ creep を防ぎやすい。

### 5.2 改善提案（優先度つき）

| 優先度 | 項目 | 提案 |
|--------|------|------|
| 高 | デバッグ体験 | RUST_LOG と Elixir Logger の連携を整備。NIF クラッシュ時のトレースをさらに分かりやすくする |
| 高 | lib.rs の分割 | 3D・Slot を入れる前に、NIF 層とゲーム固有ロジックの分離やモジュール分割を検討 |
| 中 | E2E テスト | 起動〜ゲームオーバーまでを自動で回すテストを CI に追加 |
| 中 | 2D 機能の充足 | Step 47（Skeleton/Ghost/Garlic）を完了させ、SPEC と実装を整合させる |
| 低 | マルチプレイ検証 | 44b の前に、2 ルーム同時起動などの動作を自動テストで担保 |

---

## 6. 総合所見（忌憚なく）

### 6.1 現状の位置づけ

**「技術デモ」を超えて、「実用に近いゲームエンジン」として形になっている。**

- ヴァンサバライクのデモが動き、MiniShooter で汎用化が検証されている。
- セーブ・ロード、マップ障害物、マルチルーム基盤まで揃っており、単発プロトタイプの域は脱している。
- ドキュメントの質が高く、設計と実装の対応が取りやすい。

### 6.2 率直に言える良い点

1. **アーキテクチャがぶれていない** — Elixir と Rust の役割が設計から実装まで一貫している。
2. **段階的な汎用化** — Game behaviour と Engine API の分離により、ゲーム追加のコストが下がっている。
3. **パフォーマンスをちゃんと見ている** — SoA、空間ハッシュ、SIMD、RwLock など、やるべきことがコードに落ちている。
4. **判断の根拠が残っている** — なぜその技術を選んだかがドキュメントとコメントで追える。

### 6.3 率直に言える課題

1. **デバッグはまだ重い** — Step 45 の実装は進んだが、2 言語をまたぐ問題の切り分けは依然コストが高い。
2. **2 言語の維持コスト** — 長期で見ると負荷が大きく、チームを広げるには不利になりうる。
3. **エコシステムの薄さ** — 同種プロジェクトが少なく、詰まったときに参照できる事例が限られる。
4. **lib.rs の肥大化** — このまま 3D・Slot を載せると、変更リスクと認知負荷がさらに増える。

### 6.4 一言まとめ

> **意図が明確で、設計と実装が噛み合った、質の高いプロジェクトだ。**  
> Elixir の耐障害性・分散性と Rust のパフォーマンスを組み合わせるという方針が、コードとドキュメントの両方で一貫している。  
> 残る課題は、**デバッグ支援のさらなる充実**、**lib.rs の分割・整理**、**仕様書と実装の整合**であり、アーキテクチャの根本を疑う類のものではない。  
> 3D・Slot/コンポーネント（Step 48〜61）は野心的な拡張なので、まずは現行 2D 基盤の安定化と Step 47 の仕様充足を優先し、その上で段階的に進めるのが現実的だ。

---

## 7. 将来の展望とリスク

### 7.1 ビジュアルエディタ（既存方針）

- マップ編集・エンティティ配置・ライブプレビュー・GUI 編集を想定した記載がある。
- Elixir のホットリロードと OTP を活かした「ライブデザイン」は、差別化になりうる。実装優先度はコア安定化・汎用化の後でよい。

### 7.2 Step 48〜61 について

- **Step 48〜54（3D・三人称 FPS）** — wgpu 3D、カメラ、メッシュ、プレイヤー制御、敵 AI など、現行 2D とは要求がかなり変わる。アセット・物理・当たり判定の設計がそのまま使えるかは要検証。
- **Step 55〜61（Slot・コンポーネント）** — シーングラフを Elixir で持ち、Rust はスナップショットで描画する構成は、エディタや汎用性を考えると筋が良い。一方で、既存の SoA/ゲームループとの役割分担とデータフローをどう切り替えるかが鍵。
- **リスク** — ロードマップが長く、並行して 3D と Slot の両方を進めるとリソースが分散する。「まず 2D を固める → 3D か Slot のどちらかを先行」のように、フェーズを分けた方が安全だと考えられる。

### 7.3 マルチプレイ（44b）

- Phoenix Channels 連携は設計があり、44a のルーム基盤が土台になっている。実装は「必要になったとき」でよいが、2 ルーム同時起動などの動作は早めに自動テストで固めておくと安心。

---

## 8. 関連ドキュメント

| ドキュメント | 用途 |
|-------------|------|
| [ENGINE_STRENGTHS_WEAKNESSES.md](./ENGINE_STRENGTHS_WEAKNESSES.md) | 強み・弱みの詳細比較、他エンジンとの比較 |
| [ENGINE_ANALYSIS_REVISED.md](./ENGINE_ANALYSIS_REVISED.md) | コードベース準拠の再評価 |
| [STEPS_EXTENSION.md](../05_steps/STEPS_EXTENSION.md) | Step 40〜47 の元ドキュメント |
| [STEPS_ALL.md](../05_steps/STEPS_ALL.md) | Step 1〜61 の一覧と依存関係 |
| [STEPS_3D.md](../05_steps/STEPS_3D.md) | Step 48〜54 3D・三人称 FPS |
| [STEPS_SLOT_COMPONENT.md](../05_steps/STEPS_SLOT_COMPONENT.md) | Step 55〜61 Slot・コンポーネント |
