# 1.9 3D・三人称 FPS（全7項・据え置き）

**所属**: [STEPS_ALL.md](../STEPS_ALL.md) 1章 エンジン構築 の 1.9 節。

> **据え置き**: 本節は当面保留とする。1.6〜1.8 の後に再検討する。実施順序は **1.6 Rust lib 分割・整理**（[STEPS_RUST_LIB.md](./STEPS_RUST_LIB.md)）→ **1.7 2D ゲームの固め** → **1.8 EOS 実装**（[EPIC_ONLINE_SERVICES.md](../../06_system_design/EPIC_ONLINE_SERVICES.md)）の後に再検討する。

**目的**: [ENGINE_STRENGTHS_WEAKNESSES.md](../../02_spec_design/ENGINE_STRENGTHS_WEAKNESSES.md) の「3D ゲーム適性」を上げる。Rust の **WGPU 対応プラットフォームで 3D を動かす** ことを目標に、三人称視点の FPS（TPS）ゲームを追加する。  
**前提**: 1.1〜1.5 のいずれか完了済み（既存 2D サバイバーはそのまま維持）。3D 用の新規ゲームとして「三人称 FPS」を追加する。  
**アセット**: 既存のヴァンパイアサバイバーズ系スプライトアトラスを 3D 用テクスチャとして流用する（ビルボード・簡易メッシュのテクスチャ等）。

---

## 1.9 節 全体ロードマップ（1.9.1〜1.9.7）

| 項 | 目標 |
|----|------|
| 1.9.1 | 3D レンダリング基盤（wgpu で 3D パイプライン・深度バッファ・頂点/法線/UV） |
| 1.9.2 | 3D カメラ・三人称視点（View/Projection 行列・カメラ追従） |
| 1.9.3 | 3D メッシュ描画・アトラス流用 |
| 1.9.4 | 三人称プレイヤー制御（移動・カメラ追従・照準） |
| 1.9.5 | 射撃・弾丸・レイキャスト |
| 1.9.6 | 敵の 3D スポーン・AI・衝突 |
| 1.9.7 | UI・アセット流用・ポリッシュ |

---

## 目次

1. [全体ロードマップ（詳細）](#1-全体ロードマップ)
2. [1.9.1 3D レンダリング基盤](#2-191-3d-レンダリング基盤)
3. [1.9.2 3D カメラ・三人称視点](#3-192-3d-カメラ三人称視点)
4. [1.9.3 3D メッシュ描画・アトラス流用](#4-193-3d-メッシュ描画アトラス流用)
5. [1.9.4 三人称プレイヤー制御](#5-194-三人称プレイヤー制御)
6. [1.9.5 射撃・弾丸・レイキャスト](#6-195-射撃弾丸レイキャスト)
7. [1.9.6 敵の 3D スポーン・AI・衝突](#7-196-敵の-3d-スポーンai衝突)
8. [1.9.7 UI・アセット流用・ポリッシュ](#8-197-uiアセット流用ポリッシュ)
9. [推奨実施順序と依存関係](#9-推奨実施順序と依存関係)
10. [関連ドキュメント](#10-関連ドキュメント)

---

## 1. 全体ロードマップ

```
1.9.1: 3D レンダリング基盤
  └ wgpu で 3D パイプライン・深度バッファ・頂点/法線/UV

1.9.2: 3D カメラ・三人称視点
  └ View/Projection 行列・カメラ追従

1.9.3: 3D メッシュ描画・アトラス流用
  └ 既存スプライトアトラスを 3D テクスチャに・プレイヤー/敵のメッシュ

1.9.4: 三人称プレイヤー制御
  └ 移動・カメラ追従・照準（マウス/キーボード）

1.9.5: 射撃・弾丸・レイキャスト
  └ FPS 武器・ヒット判定

1.9.6: 敵の 3D スポーン・AI・衝突
  └ 敵配置・追跡 AI・ダメージ・経験値

1.9.7: UI・アセット流用・ポリッシュ
  └ HUD・BGM/SE 流用・ゲームループ統合
```

**目標**: WGPU が動作する環境（Windows / macOS / Linux / 将来 WebGPU）で、三人称視点のシューティングゲームがプレイ可能になること。

---

## 2. 1.9.1 3D レンダリング基盤

### 2.1 目標

- **wgpu で 3D パイプライン**を追加する（既存 2D スプライトパイプラインは維持）
- **深度バッファ（Depth Buffer）** を有効にし、前後関係を正しく描画する
- **頂点データ**を 3D 化（position: vec3, 必要に応じて normal / uv）

### 2.2 なぜ重要か

- 現状は 2D 専用（Vertex position: [f32; 2]、Z なし）。3D を動かすには別パイプラインと深度テストが必須
- [ENGINE_STRENGTHS_WEAKNESSES.md](../../02_spec_design/ENGINE_STRENGTHS_WEAKNESSES.md) の「3D レンダリング・物理演算の実装がない」を解消する第一歩

### 2.3 責務分離

| レイヤー | 担当 |
|----------|------|
| **Rust** | 3D パイプライン作成、深度バッファ作成・バインド、3D 用シェーダ（vertex/fragment）、頂点バッファ形式 |
| **Elixir** | ゲーム選択（2D vs 3D）やシーン切替は既存 Engine の流れで制御。3D 専用ロジックは Rust 内で完結させるか、NIF で状態を渡す |

### 2.4 実装内容

#### 48.1 深度バッファ

- `TextureFormat::Depth32Float`（または `Depth24Plus`）で深度テクスチャを作成
- `render_pass.set_depth_stencil` で深度テストを有効化（`CompareFunction::Less`）
- リサイズ時に深度テクスチャも一緒に再作成

#### 48.2 3D 用頂点・パイプライン

- 頂点: `position: [f32; 3]`, `normal: [f32; 3]`, `uv: [f32; 2]` など、必要最小限で定義
- シェーダ: MVP 行列（Model, View, Projection）を uniform で渡し、`gl_Position = proj * view * model * vec4(position, 1.0)` でクリップ空間に変換
- 既存 2D パイプラインとは別の `RenderPipeline` として追加し、ゲーム種別やフラグで切り替え

#### 48.3 最小描画（スモークテスト）

- 1 個の立方体または地面用の四角形を 3D で描画し、深度が有効であることを確認
- カメラは仮で固定（1.9.2 で View/Projection を本実装）

### 2.5 確認ポイント

- [ ] 深度バッファを有効にした 3D パイプラインで 1 個のメッシュが正しく描画される
- [ ] 既存 2D ゲーム（vampire_survivor）は従来どおり動作する（パイプライン分離）
- [ ] WGPU が動作するプラットフォームでビルド・実行できる

---

## 3. 1.9.2 3D カメラ・三人称視点

### 3.1 目標

- **View 行列**: カメラの位置・向き（三人称ではプレイヤー後方・やや上）
- **Projection 行列**: 透視投影（aspect ratio, FOV, near/far）
- **三人称視点**: カメラがプレイヤーを追従し、マウス等で視点方向を回転できるようにする（1.9.4 で入力と連動）

### 3.2 なぜ重要か

- 3D ではカメラ行列が必須。三人称 FPS では「プレイヤー背後から見る」カメラが前提

### 3.3 実装内容

#### 49.1 行列計算

- **Projection**: `cgmath::perspective` または自前で `fov_y`, `aspect`, `near`, `far` から透視行列を構築
- **View**: カメラ位置 `eye`、注視点 `target`、上方向 `up` から LookAt 行列を構築
- 初期状態: カメラを (0, 5, 10) などプレイヤー後方に配置し、プレイヤー位置を注視

#### 49.2 Uniform バッファ

- 3D パイプライン用に `Uniforms { view_proj: [[f32; 4]; 4] }` などを GPU に渡す
- 毎フレーム `view * projection` を計算し、uniform を更新

#### 49.3 三人称用パラメータ

- オフセット: プレイヤー位置から「後方・上」のオフセット（例: 0, 3, 8）
- 俯角: やや上から見下ろす角度。1.9.4 でマウス Y と連動させる

### 3.4 確認ポイント

- [ ] 透視投影で 3D シーンが正しく表示される
- [ ] カメラ位置を変えると見え方が変わる（デバッグ用にキーでカメラ移動してもよい）

---

## 4. 1.9.3 3D メッシュ描画・アトラス流用

### 4.1 目標

- **既存スプライトアトラス**（ヴァンパイアサバイバーズ系）を 3D 用テクスチャとして利用する
- プレイヤー・敵・弾を **簡易 3D メッシュ**（立方体・板ポリゴン・ビルボード等）で描画し、アトラスから UV で切り出して貼る

### 4.2 なぜ重要か

- 新規アセットを増やさず、既存 `assets/sprites/atlas.png` を流用する（仕様どおり「ヴァンサバの画像の流用」）

### 4.3 実装内容

#### 50.1 アトラスを 3D 用テクスチャに

- 既存 `AssetLoader` / アトラス読み込みを流用し、同一画像を 3D パイプラインのテクスチャとしてバインド
- サンプラは繰り返しなし（Clamp）で UV 範囲外をはみ出さないようにする

#### 50.2 メッシュの形態

- **プレイヤー**: 簡易キャラ（1 個の箱 + アトラスのプレイヤー用 UV）または Y 軸垂直の板ポリゴン（ビルボード）でプレイヤースプライトを表示
- **敵**: 同様にアトラスの敵スプライトを 3D で表示（板ポリゴン or 箱）
- **弾**: 小さい板または箱で、弾用 UV を貼る

#### 50.3 インスタンシング（任意）

- 敵・弾が複数ある場合、2D と同様にインスタンス描画（1 draw call で複数体）を検討。インスタンスごとに `model` 行列（位置・回転・スケール）を渡す

### 4.4 確認ポイント

- [ ] アトラス画像が 3D オブジェクトに正しく貼って表示される
- [ ] プレイヤー・敵・弾の「見た目」が既存アトラスの領域と対応している

---

## 5. 1.9.4 三人称プレイヤー制御

### 5.1 目標

- **移動**: WASD（または矢印）で XZ 平面上を移動（Y は地面固定またはジャンプなしで平面）
- **カメラ追従**: カメラはプレイヤー位置 + オフセット。マウス移動で水平・垂直方向の視点回転
- **照準**: カメラの向き＝プレイヤーの「向き」として、射撃方向に使う（1.9.5 で利用）

### 5.2 なぜ重要か

- 三人称 FPS の基本操作。入力とカメラ・プレイヤー向きの一致が必須

### 5.3 責務分離

| レイヤー | 担当 |
|----------|------|
| **Rust** | 入力ポーリング（既存 game_window と同様）、プレイヤー位置・向きの更新、カメラ行列の更新 |
| **Elixir** | 3D ゲーム用のシーン・入力マッピングの設定。詳細は既存 InputHandler/ETS の流れに乗せるか、Rust 内で完結させる |

### 5.4 実装内容

#### 51.1 プレイヤー状態（3D）

- `position: [f32; 3]`（X, Y, Z）。Y は地面の高さで固定でも可
- `yaw: f32`（水平角）, `pitch: f32`（俯仰角、オプション）。カメラと同期

#### 51.2 入力

- キーボード: 前後左右の移動ベクトルを XZ 平面に反映。カメラの「前」方向の XZ 成分で進行方向を決める
- マウス: 相対移動量で yaw/pitch を更新。カメラの View 行列をプレイヤー位置 + yaw/pitch で再計算

#### 51.3 カメラ更新

- 毎フレーム: プレイヤー位置 + オフセット（yaw/pitch で回転した「後ろ・上」）をカメラ位置とする
- LookAt の target はプレイヤー位置の少し前（照準方向）またはプレイヤー位置

### 5.5 確認ポイント

- [ ] WASD でプレイヤーが 3D 空間を移動する
- [ ] マウスで視点が回り、カメラがプレイヤーを追従する
- [ ] プレイヤーメッシュの向きが照準方向と一致する（または一致しているように見える）

---

## 6. 1.9.5 射撃・弾丸・レイキャスト

### 6.1 目標

- **射撃**: マウスクリック（またはキー）で弾を発射。発射方向はカメラの前方（プレイヤーの向き）
- **弾丸**: 3D 空間を直進し、一定距離または敵に当たると消える
- **ヒット判定**: レイキャスト（画面中央からレイを飛ばす）で即時ヒット、または弾丸メッシュと敵の当たり判定のいずれか（または両方）

### 6.2 なぜ重要か

- FPS のコア体験。三人称でも「照準して撃つ」を実装する

### 6.3 実装内容

#### 52.1 弾丸データ

- 位置 `[f32; 3]`、方向（正規化ベクトル）、速度、生存時間または最大距離
- 毎フレーム: 位置 += 方向 * 速度 * dt。範囲外 or ヒットで削除

#### 52.2 レイキャスト（オプション）

- カメラの前方レイと敵のバウンディング（球 or AABB）の交差判定。ヒットしたら即ダメージ
- 即ヒット方式の場合は弾丸メッシュを出さず「レイ＝弾」としてもよい

#### 52.3 弾丸と敵の衝突

- 弾丸リストと敵リストで距離判定（球 vs 点 または 球 vs 球）。ヒット時は弾を消し、敵にダメージを加える（1.9.6 で敵 HP と連携）

### 6.4 確認ポイント

- [ ] クリック（またはキー）で弾が発射され、飛んでいく
- [ ] 敵に当たると弾が消え、敵にダメージが入る（1.9.6 と合わせて）

---

## 7. 1.9.6 敵の 3D スポーン・AI・衝突

### 7.1 目標

- **敵の 3D 配置**: プレイヤー周囲に敵をスポーン。既存アトラスの敵スプライトを 3D で表示
- **AI**: プレイヤーに向かって移動（Chase）。既存 2D の Chase AI を XZ 平面（または 3D 空間）に拡張
- **衝突**: 敵がプレイヤーに接触するとプレイヤーにダメージ。弾が敵に当たると敵にダメージ・撃破で経験値（1.9.7 でドロップ表示も可）

### 7.2 なぜ重要か

- 三人称 FPS として「敵を倒す」ループを成立させる

### 7.3 責務分離

| レイヤー | 担当 |
|----------|------|
| **Rust** | 敵の位置・HP・状態、Chase AI（3D 移動）、プレイヤーとの接触判定、弾との当たり判定、経験値オーブの生成（オプション） |
| **Elixir** | ウェーブ・スポーンタイミングの制御は既存 EventBus/GameEvents の流れに乗せるか、Rust 内で時間ベーススポーンにする |

### 7.4 実装内容

#### 53.1 敵データ（3D）

- `position: [f32; 3]`, `hp: f32`, `kind_id`（表示用 UV の切り替え）、速度など
- 既存 `EnemyWorld` の 3D 版、または 3D ゲーム専用の `EnemyWorld3d` を検討

#### 53.2 スポーン

- プレイヤーから一定距離の XZ 円上にスポーン。Y は地面と同一
- 時間経過または既存のウェーブイベントでスポーン数を制御

#### 53.3 衝突

- 敵 vs プレイヤー: 距離 < しきい値でプレイヤーにダメージ、ノックバック等はオプション
- 弾 vs 敵: 1.9.5 で実装したヒットで HP 減少。0 以下で撃破・経験値（とアトラス上のジェム等をドロップ表示）

### 7.5 確認ポイント

- [ ] 敵が 3D 空間に出現し、プレイヤーに向かって動く
- [ ] 弾で敵を倒すと敵が消え、スコアまたは経験値が増える
- [ ] 敵がプレイヤーに触れるとプレイヤーの HP が減る

---

## 8. 1.9.7 UI・アセット流用・ポリッシュ

### 8.1 目標

- **HUD**: HP・スコア・弾数（必要なら）を 2D オーバーレイで表示。既存 egui または 2D スプライトで描画
- **BGM/SE**: 既存 `assets/audio` の BGM・SE を 3D ゲームでも流用
- **ゲームループ統合**: 3D ゲームを既存 Engine の「ゲーム選択」で起動できるようにする（config で `game_id: :tps_3d` など）

### 8.2 なぜ重要か

- アセット流用とエンジン汎用化の一環。既存の音声・UI 基盤を活かす

### 8.3 実装内容

#### 54.1 ゲーム登録

- 既存の Game behaviour に 3D ゲームを追加。`render_type: :render_3d` のようなフラグで 3D パイプラインを選択
- アセットパスは既存サバイバーと共通（アトラス・BGM/SE）でよい

#### 54.2 UI

- HP バー・スコア表示は 2D レイヤーで描画（3D の上に重ねる）。既存 HUD の流用または簡易版

#### 54.3 音声

- rodio で BGM/SE 再生。既存 AssetLoader 経由で同じファイルを指定

### 8.4 確認ポイント

- [ ] 3D ゲームが「ゲーム選択」から起動できる
- [ ] HUD に HP・スコアが表示される
- [ ] BGM/SE が再生される（既存アセット流用）

---

## 9. 推奨実施順序と依存関係

```
1.9.1 → 1.9.2 → 1.9.3 → 1.9.4 → 1.9.5 → 1.9.6 → 1.9.7
```

- **48**: 3D の土台。必須
- **49**: カメラがないと 3D が正しく見えない
- **50**: 見た目をアトラスで整える
- **51**: 操作とカメラの一体化
- **52**: 射撃がないと FPS として成立しない
- **53**: 敵と衝突でゲームプレイが成立
- **54**: 仕上げ・既存エンジンとの統合

**前提**: 1.4（汎用化）が済んでいることが望ましい。1.5 は 2D サバイバー向けのため、3D は並行して 1.9.1 から開始可能。

---

## 10. 関連ドキュメント

| ドキュメント | 用途 |
|-------------|------|
| [ENGINE_STRENGTHS_WEAKNESSES.md](../../02_spec_design/ENGINE_STRENGTHS_WEAKNESSES.md) | 3D/モバイル適性の目標・現状 |
| [STEPS_ALL.md](../STEPS_ALL.md) | 全体ロードマップ・章・節・項構成 |
| [STEPS_EXTENSION.md](./STEPS_EXTENSION.md) | 1.5 拡張（2D 拡張） |
| [ASSET_MANAGEMENT.md](../../06_system_design/ASSET_MANAGEMENT.md) | アセット ID・パス・アトラス流用 |
| [ELIXIR_RUST_DIVISION.md](../../03_tech_decisions/ELIXIR_RUST_DIVISION.md) | Elixir/Rust 責務分離 |
